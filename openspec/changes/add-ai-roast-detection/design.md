## Context

当前系统是纯本地处理的小程序，所有计算都在客户端完成。新增AI检测功能需要引入后端服务（云函数）和云存储，这是架构上的重要变化。

### 技术约束
- 微信小程序环境限制：不能直接调用外部API（需要云函数代理）
- ModelScope API密钥安全：不能暴露在小程序前端代码中
- 图片存储：需要将图片上传到云存储，然后传递给AI模型
- 成本考虑：ModelScope API调用和云存储都有成本，需要合理使用

### 用户需求
- 提供更智能的检测方式，无需手动选择采样点
- 保持现有本地检测功能，给用户选择权
- AI检测结果应该包含烘焙度、颜色细分、L*值、Agtron值

## Goals / Non-Goals

### Goals
- 实现基于ModelScope视觉大模型的AI烘焙度检测
- 安全地调用外部API（通过云函数）
- 提供良好的用户体验（上传进度、加载状态、错误提示）
- 保持与现有本地检测功能的兼容性

### Non-Goals
- 不替换现有的本地检测功能，而是作为补充
- 不实现图片的长期存储（检测完成后可以删除）
- 不在本阶段实现AI模型训练或优化

## Decisions

### Decision 1: 使用云函数调用ModelScope API
**选择**: 在CloudBase云函数中调用ModelScope API，而不是直接从小程序调用

**原因**:
- 保护API密钥安全，避免暴露在前端代码中
- 微信小程序网络请求限制，云函数可以更好地处理外部API调用
- 可以在云函数中实现重试、错误处理等逻辑

**替代方案**: 
- 直接从小程序调用：❌ 不安全，API密钥会暴露
- 使用HTTP云函数：✅ 可行，但需要处理CORS和认证

### Decision 2: 图片上传到云存储
**选择**: 将图片上传到CloudBase云存储，然后传递云存储URL给AI模型

**原因**:
- ModelScope API需要图片URL，不能直接传递base64（对于大图片）
- 云存储提供临时访问URL，适合AI模型访问
- 可以控制图片的访问权限和生命周期

**替代方案**:
- 使用base64编码：❌ 对于大图片会导致请求过大
- 使用第三方图床：⚠️ 增加外部依赖

### Decision 3: 检测模式选择
**选择**: 在UI中提供"本地检测"和"AI检测"两种模式选择

**原因**:
- 保持现有功能的完整性
- 给用户选择权，适应不同场景（有网络/无网络，需要快速检测/需要精确检测）
- 两种方式可以互相验证

**替代方案**:
- 默认使用AI检测：⚠️ 可能增加成本和延迟
- 自动选择模式：⚠️ 用户可能不理解为什么选择某种模式

### Decision 4: AI检测结果格式
**选择**: AI返回的结果包含烘焙度、颜色细分、L*值、Agtron值，与本地检测结果格式一致

**原因**:
- 保持结果展示的一致性
- 方便用户对比两种检测方式的结果
- 符合UCCC标准的数据结构

## Risks / Trade-offs

### Risk 1: API调用成本
**风险**: ModelScope API调用会产生费用，如果用户频繁使用可能产生较高成本

**缓解措施**:
- 在UI中提示用户AI检测需要网络和可能产生费用
- 考虑添加使用频率限制（未来）
- 监控API调用量

### Risk 2: 网络延迟
**风险**: AI检测需要上传图片和调用API，可能比本地检测慢

**缓解措施**:
- 提供清晰的加载状态提示
- 优化图片上传（压缩、进度显示）
- 考虑添加超时处理

### Risk 3: API可用性
**风险**: ModelScope API可能不可用或返回错误

**缓解措施**:
- 实现完善的错误处理和用户提示
- 提供降级方案（提示用户使用本地检测）
- 记录错误日志便于排查

### Risk 4: 图片隐私
**风险**: 图片上传到云存储可能涉及隐私问题

**缓解措施**:
- 明确告知用户图片会上传到云端
- 考虑检测完成后自动删除图片（可选）
- 遵守数据保护相关法规

## Migration Plan

### 阶段1: 基础功能开发
1. 创建云函数和云存储工具函数
2. 实现图片上传功能
3. 实现AI检测调用

### 阶段2: UI集成
1. 添加检测模式选择UI
2. 实现AI检测流程
3. 扩展结果展示

### 阶段3: 测试和优化
1. 功能测试
2. 性能优化
3. 错误处理完善

### 阶段4: 部署
1. 部署云函数
2. 配置环境变量
3. 生产环境验证

## Open Questions

1. **图片存储策略**: 检测完成后是否自动删除云存储中的图片？还是保留一段时间？
2. **使用限制**: 是否需要添加AI检测的使用频率限制？
3. **结果对比**: 是否需要提供AI检测和本地检测结果的对比功能？
4. **成本控制**: 是否需要添加使用量统计和成本提醒？
