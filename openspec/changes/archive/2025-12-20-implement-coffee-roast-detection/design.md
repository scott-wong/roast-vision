# Design: 咖啡豆烘焙度检测实现

## Context

实现微信小程序工具，通过拍照检测咖啡豆/粉的烘焙度。核心流程：图片选择 → Canvas处理 → RGB提取 → Lab转换 → Agtron计算 → 结果展示。所有处理在本地完成，无后端依赖。

## Goals / Non-Goals

### Goals
- 实现完整的颜色空间转换算法（RGB→XYZ→Lab）
- 基于UCCC标准实现准确的Agtron值计算
- 提供直观的多点采样交互界面
- 支持检测历史记录的本地存储和查看

### Non-Goals
- 不实现用户认证和云端同步
- 不实现图片编辑功能（裁剪、旋转等）
- 不实现多设备数据同步
- 不实现社交分享功能（当前版本）

## Decisions

### Decision: 使用Canvas 2D API进行像素提取
**Why**: Canvas 2D API提供了直接访问像素数据的能力，可以精确提取指定坐标的RGB值，适合实现多点采样功能。

**Alternatives considered**:
- 使用图片处理库：增加了依赖，且小程序环境限制较多
- 使用云函数处理：违背了"无后端依赖"的约束

### Decision: 实现完整的颜色空间转换链（RGB→XYZ→Lab）
**Why**: Lab颜色空间是UCCC标准的基础，必须从RGB完整转换。使用D65标准光源进行XYZ转换，确保颜色准确性。

**Alternatives considered**:
- 使用近似公式：可能影响准确性，不符合专业检测需求
- 使用查找表：占用存储空间，且精度有限

### Decision: 使用5个采样点的L*平均值计算Agtron值
**Why**: 多点采样可以减少单点误差，平均值更能反映整体烘焙度。5个点平衡了准确性和操作复杂度。

**Alternatives considered**:
- 单点采样：误差较大
- 更多采样点：操作复杂，用户体验下降

### Decision: 使用微信小程序本地存储API保存历史记录
**Why**: 满足"无后端依赖"要求，本地存储API简单可靠，适合存储检测结果数据。

**Alternatives considered**:
- 云数据库：需要后端服务，不符合当前约束
- 文件系统：小程序环境限制，本地存储更合适

### Decision: 实现独立的历史记录页面
**Why**: 提供更好的用户体验，独立页面可以展示更多历史记录信息，支持批量操作和详情查看。

**Implementation details**:
- 历史记录页面 (`pages/history/history`) 支持查看、删除、导出功能
- 每条记录保存：时间戳、Agtron值、烘焙度、颜色描述、L*值、5个采样点的Lab值
- 最多保存100条记录，超出后自动删除最早的记录
- 支持导出历史记录到剪贴板

## Risks / Trade-offs

### 风险：不同设备屏幕和光照条件影响颜色准确性
**缓解措施**: 
- 在UI中提供使用提示，建议在标准光照条件下拍摄
- 使用D65标准光源进行颜色转换，减少设备差异

### 风险：大图片处理可能影响性能
**缓解措施**:
- 在Canvas处理前对图片进行适当压缩
- 使用异步处理，避免阻塞UI

### 风险：本地存储空间限制（10MB）
**缓解措施**:
- 历史记录仅保存关键数据（时间、Agtron值、Lab值），不保存完整图片
- 提供历史记录清理功能
- 限制最多保存100条记录，超出后自动删除最早的记录

## Migration Plan

当前代码为微信小程序默认模板，需要完全重写主页面逻辑。无数据迁移需求。

## Implementation Status

### 已实现功能
- ✅ 图片选择（拍照和相册）
- ✅ Canvas图片处理和像素提取
- ✅ RGB到Lab颜色空间转换
- ✅ Agtron值计算（基于UCCC标准）
- ✅ 5点采样交互界面
- ✅ 检测结果展示
- ✅ 历史记录保存和管理
- ✅ 独立历史记录页面
- ✅ 历史记录导出功能（复制到剪贴板）

### 实现细节
- 使用Canvas 2D API进行像素提取，支持设备像素比（DPR）适配
- 采样点坐标转换：支持图片缩放后的坐标映射到原始像素坐标
- 自动滚动：检测完成后自动滚动到结果区域
- 历史记录数据结构：包含完整检测信息，支持详情查看

## Open Questions

- 是否需要支持图片的缩放和平移功能，以便用户更精确地选择采样点？

